#!/bin/bash

set -e

# Source .skaffold.env file if it exists
if [[ -f .skaffold.env ]]; then
    set -a
    eval "$(cat '.skaffold.env')"
    set +a
fi

# Default to AWS if no cloud provider flag is provided
CLOUD_PROVIDER="aws"
DOMAINNAME="aurelia.honeydemo.io"
INGRESS_CLASS="alb"

# Parse cloud provider flag if provided
if [[ "$1" == "--cloud" ]] || [[ "$1" == "-c" ]]; then
    CLOUD_PROVIDER="$2"
    # Validate the cloud provider argument
    if [[ ! "$CLOUD_PROVIDER" =~ ^(aws|azure)$ ]]; then
        echo "Error: Invalid cloud provider '$CLOUD_PROVIDER'"
        echo "Usage: $0 [--cloud|-c aws|azure] [SERVICES...]"
        echo "Default: aws"
        exit 1
    fi
    # Remove the cloud provider flags from the arguments
    shift 2
fi

SERVICES=$*
if [ -z "$SERVICES" ]; then
# SERVICES should contain something listed as an image in skaffold.yaml (subset of the name of an image works too)
  SERVICES="nothing-things-are-v-slow-when-you-do-this" # please specify a container
  echo "************************************"
  echo "      Using all default services    "
  echo "************************************"
fi

# install/update the secret if it's changed
# Note: hack until the helm file allows it to be specified as a value
kubectl create namespace $USER-local --dry-run=client -o yaml | kubectl apply -f - > /dev/null
kubectl create --namespace $USER-local secret generic htp-builder \
   --from-literal=management-api-secret=$PIPELINE_MANAGEMENT_API_SECRET \
   --from-literal=pipeline-telemetry-key=$PIPELINE_TELEMETRY_INGEST_KEY \
   --dry-run=client -o yaml | kubectl apply -f - > /dev/null

# Get container registry from Pulumi stack output based on cloud provider
if [[ "$CLOUD_PROVIDER" == "aws" ]]; then
    echo "Using AWS configuration"
    CONTAINER_REGISTRY=$(pulumi stack output -s honeycomb-devrel/infra-aws/prod ecrRepositoryUrlPrefix 2>/dev/null)
    echo "Logging in to ECR, because it's so annoying when we forget."
    scripts/login-ecr.sh > /dev/null 2>&1

    # export the bucket information
    SOURCE_MAPS_BUCKET=$(pulumi stack output -s honeycomb-devrel/infra-aws/prod sourcemapsBucketName 2>/dev/null)
    SOURCE_MAPS_BUCKET_REGION=$(pulumi stack output -s honeycomb-devrel/infra-aws/prod s3Region 2>/dev/null)
    SOURCE_MAPS_PREFIX=$USER
elif [[ "$CLOUD_PROVIDER" == "azure" ]]; then
    echo "Using Azure configuration"
    CONTAINER_REGISTRY=$(pulumi stack output -s honeycomb-devrel/infra-azure/prod acrName 2>/dev/null)
    echo "Logging in to ACR, because it's so annoying when we forget."
    scripts/login-acr.sh > /dev/null 2>&1
    DOMAINNAME="zurelia.honeydemo.io"
    INGRESS_CLASS="webapprouting.kubernetes.azure.com"
fi

# Set kubectl context for the appropriate cloud provider
echo "Setting kubectl context for $CLOUD_PROVIDER..."
scripts/set-kubecontext.sh "$CLOUD_PROVIDER" > /dev/null 2>&1

export CLOUD_PROVIDER
export DOMAINNAME
export INGRESS_CLASS
export SOURCE_MAPS_BUCKET
export SOURCE_MAPS_BUCKET_REGION
export SOURCE_MAPS_PREFIX

# maybe someday the container registry name will change, but this is what it is now
skaffold run -d "$CONTAINER_REGISTRY" -b $SERVICES --port-forward=user -l skaffold.dev/run-id=static --cache-artifacts=false

# note: if the output ends with
#   Error: UPGRADE FAILED: another operation (install/upgrade/rollback) is in progress
# then do something like this:
#   helm rollback -n  jessicakerr-local jessicakerr
# maybe later I can get this to print usefully
