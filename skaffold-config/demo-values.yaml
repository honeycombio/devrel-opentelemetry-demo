########################
#
# This is the configuration for the Otel demo deployed to {you}-local, not the main demo.
#
########################
default:
  replicas: 1

components:
  loadgenerator:
    replicas: 1

opentelemetry-collector:
  enabled: true
  mode: daemonset
  service:
    enabled: true      
  presets:
    logsCollection:
      enabled: true
      includeCollectorLogs: false
  config:
    receivers:
      otlp:
        protocols:
          grpc:
          http:
            cors:
              allowed_origins:
                - http://*
                - https://*
            endpoint: 0.0.0.0:4318
      filelog:
        include:
        - /var/log/pods/${env:NAMESPACE}_*/*/*.log
    processors:
      transform/service_names:
        error_mode: ignore
        log_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], "api-gateway") where attributes["service.name"] == "frontend"
              - set(attributes["service.name"], "ingress-gateway") where attributes["service.name"] == "frontendproxy"
        metric_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], "api-gateway") where attributes["service.name"] == "frontend"
              - set(attributes["service.name"], "ingress-gateway") where attributes["service.name"] == "frontendproxy"
        trace_statements:
          - context: resource
            statements:
              - set(attributes["service.name"], "api-gateway") where attributes["service.name"] == "frontend"
              - set(attributes["service.name"], "ingress-gateway") where attributes["service.name"] == "frontendproxy"
    exporters:
      otlp/traces:
        endpoint: api.honeycomb.io:443
        headers:
          x-honeycomb-team: ${HONEYCOMB_API_KEY}

      otlp/metrics:
        endpoint: api.honeycomb.io:443
        headers:
          x-honeycomb-team: ${HONEYCOMB_API_KEY}
          x-honeycomb-dataset: service-metrics

      otlp/logging:
        endpoint: api.honeycomb.io:443
        headers:
          x-honeycomb-team: ${HONEYCOMB_API_KEY}
          x-honeycomb-dataset: service-logs

      otlp/k8s-logging:
        endpoint: api.honeycomb.io:443
        headers:
          x-honeycomb-team: ${HONEYCOMB_API_KEY}
          x-honeycomb-dataset: k8s-logs

    service:
      pipelines:
        metrics:
          exporters: 
            - otlp/metrics
          processors:
            - transform/service_names
        logs:
          exporters: 
            - otlp/logging
          processors:
            - transform/service_names
        traces:
          exporters: 
            - otlp/traces
            - spanmetrics
          processors:
            - transform/service_names
  ports:
    otlp:
      hostPort: 0
    otlp-http:
      hostPort: 0
    jaeger-compact:
      hostPort: 0
    jaeger-thrift:
      hostPort: 0
    jaeger-grpc:
      hostPort: 0
    zipkin:
      hostPort: 0
